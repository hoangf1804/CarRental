  services:
    zookeeper:
      image: confluentinc/cp-zookeeper:7.4.0
      container_name: zookeeper
      environment:
        ZOOKEEPER_CLIENT_PORT: 2181
        ZOOKEEPER_TICK_TIME: 2000
      ports:
        - "2181:2181"
      networks:
        - rentalcar_rental-network
  
    kafka:
      image: confluentinc/cp-kafka:7.4.0
      container_name: kafka
      depends_on:
        - zookeeper
      environment:
        KAFKA_BROKER_ID: 1
        KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
        KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
        KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
        KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
        KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      ports:
        - "9092:9092"
      networks:
        - rentalcar_rental-network
  
  
    zipkin:
      image: openzipkin/zipkin:latest
      container_name: zipkin
      ports:
        - "9411:9411"   # C·ªïng m·∫∑c ƒë·ªãnh c·ªßa Zipkin
      networks:
        - rentalcar_rental-network
  
    keycloak:
      image: quay.io/keycloak/keycloak:21.0.1
      container_name: keycloak
      command: start-dev
      environment:
        - KEYCLOAK_ADMIN=admin
        - KEYCLOAK_ADMIN_PASSWORD=admin
      ports:
        - "8085:8080"
      volumes:
        - keycloak_data:/opt/keycloak/data
      networks:
        - rentalcar_rental-network
  
  
    postgres:
      image: postgres:15
      container_name: postgres
      environment:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
      ports:
        - "5432:5432"
      volumes:
        - postgres-data:/var/lib/postgresql/data
        - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      networks:
        - rentalcar_rental-network
  
    discovery-server:
      build: ./discovery-server
      container_name: discovery-server
      ports:
        - "8761:8761"
      networks:
        - rentalcar_rental-network
  
    api-gateway:
      build: ./api-gateway
      container_name: api-gateway
      depends_on:
        - discovery-server
      ports:
        - "8080:8080"
      environment:
        - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/  # ƒê·ªãa ch·ªâ Eureka
        - EUREKA_CLIENT_REGISTER_WITH_EUREKA=true  # ƒê·∫£m b·∫£o Gateway ƒëƒÉng k√Ω v√†o Eureka
        - EUREKA_CLIENT_FETCH_REGISTRY=true  # ƒê·∫£m b·∫£o Gateway c√≥ th·ªÉ l·∫•y danh s√°ch service
      networks:
        - rentalcar_rental-network
  
    rental-service:
      build: ./rental-service
      container_name: rental-service
      depends_on:
        - discovery-server
        - postgres
        - keycloak
        - api-gateway
      environment:
        SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/rentaldb
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres
        EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/
        EUREKA_CLIENT_REGISTER_WITH_EUREKA: "true"
  
        # üëá Th√™m d√≤ng n√†y (ch√¨a kh√≥a quan tr·ªçng)
        SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://keycloak:8080/realms/RentACarMicroservice/protocol/openid-connect/certs
  
      ports:
        - "8081:8081"
      networks:
        - rentalcar_rental-network
    invoice-service:
      build: ./invoice-service
      container_name: invoice-service
      depends_on:
        - discovery-server
        - postgres
        - keycloak
        - api-gateway
        - kafka
        - zipkin
      environment:
        SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/invoicedb
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres
        EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/
        EUREKA_CLIENT_REGISTER_WITH_EUREKA: "true"
  
        # üëá Th√™m d√≤ng n√†y (ch√¨a kh√≥a quan tr·ªçng)
        SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://keycloak:8080/realms/RentACarMicroservice/protocol/openid-connect/certs
        SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      ports:
        - "8083:8083"
      networks:
        - rentalcar_rental-network
    inventory-service:
      build: ./inventory-service
      container_name: inventory-service
      depends_on:
        - discovery-server
        - postgres
        - keycloak
        - api-gateway
        - kafka
        - zipkin
      environment:
        SPRING_ZIPKIN_BASE_URL: http://zipkin:9411
        SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/inventorydb
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres
        EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/
        EUREKA_CLIENT_REGISTER_WITH_EUREKA: "true"
  
        # üëá Th√™m d√≤ng n√†y (ch√¨a kh√≥a quan tr·ªçng)
        SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://keycloak:8080/realms/RentACarMicroservice/protocol/openid-connect/certs
        SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      ports:
        - "8086:8086"
      networks:
        - rentalcar_rental-network
    filter-service:
      build: ./filter-service
      container_name: filter-service
      depends_on:
        - discovery-server
        - mongo
        - zookeeper
        - kafka
        - api-gateway
        - mongo-express
        - keycloak
        - zipkin
      environment:
        SPRING_DATA_MONGODB_URI: mongodb://mongo:27017/filterdb
        SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
        EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/
        EUREKA_CLIENT_REGISTER_WITH_EUREKA: "true"
  
      ports:
        - "8084:8084"
      networks:
        - rentalcar_rental-network
    mongo:
      image: mongo:6.0
      container_name: mongo
      command: [ "--bind_ip_all" ]
      environment:
        - MONGO_INITDB_ROOT_USERNAME=admin
        - MONGO_INITDB_ROOT_PASSWORD=pass
      ports:
        - "27017:27017"
      volumes:
        - mongo-data:/data/db
      networks:
        - rentalcar_rental-network
  
    mongo-express:
      image: mongo-express:1.0.2
      environment:
        - ME_CONFIG_MONGODB_SERVER=mongo
        - ME_CONFIG_MONGODB_PORT=27017
        - ME_CONFIG_MONGODB_ADMINUSERNAME=admin
        - ME_CONFIG_MONGODB_ADMINPASSWORD=pass
        - ME_CONFIG_BASICAUTH_USERNAME=admin
        - ME_CONFIG_BASICAUTH_PASSWORD=pass
      depends_on:
        - mongo
      ports:
        - "8088:8081"
  
      networks:
          - rentalcar_rental-network
  
    payment-service:
      build: ./payment-service
      container_name: payment-service
      depends_on:
        - discovery-server
        - postgres
        - keycloak
        - api-gateway
      environment:
        SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/paymentdb
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres
        EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://discovery-server:8761/eureka/
        EUREKA_CLIENT_REGISTER_WITH_EUREKA: "true"
      ports:
        - "8082:8082"
      networks:
        - rentalcar_rental-network
  volumes:
    postgres-data:
    keycloak_data:
    mongo-data:
  
  
  networks:
    rentalcar_rental-network:
      external: true
